{"version":3,"names":["useEffect","useState","useFPSMetric","frameState","setFrameState","fps","lastStamp","Date","now","framesCount","average","totalCount","lowestFps","timeout","requestAnimationFrame","setTimeout","currentStamp","shouldSetState","newFramesCount","newValue","newMean","Math","min","clearTimeout","resetLowFpsFn","resetLowFps"],"sources":["useFPSMetrics.tsx"],"sourcesContent":["import { useEffect, useState } from \"react\";\n\ntype FrameData = {\n  fps: number;\n  lastStamp: number;\n  framesCount: number;\n  average: number;\n  totalCount: number;\n  lowestFps: number;\n};\nexport type FPS = { average: FrameData[\"average\"]; fps: FrameData[\"fps\"] };\n\nexport function useFPSMetric(): {\n  average: number;\n  fps: number;\n  lowestFps: number;\n  resetLowFps: Function;\n  lastStamp: number;\n} {\n  const [frameState, setFrameState] = useState<FrameData>({\n    fps: 0,\n    lastStamp: Date.now(),\n    framesCount: 0,\n    average: 0,\n    totalCount: 0,\n    lowestFps: 240,\n  });\n\n  useEffect(() => {\n    // NOTE: timeout is here\n    // because requestAnimationFrame is deferred\n    // and to prevent setStates when unmounted\n    let timeout: NodeJS.Timeout | null = null;\n\n    requestAnimationFrame((): void => {\n      timeout = setTimeout((): void => {\n        const currentStamp = Date.now();\n        const shouldSetState = currentStamp - frameState.lastStamp > 1000;\n        const newFramesCount = frameState.framesCount + 1;\n        // updates fps at most once per second\n        if (shouldSetState) {\n          const newValue = frameState.framesCount;\n          const totalCount = frameState.totalCount + 1;\n          // I use math.min here because values over 60 aren't really important\n          // I calculate the mean fps incrementally here instead of storing all the values\n          const newMean = Math.min(\n            frameState.average + (newValue - frameState.average) / totalCount,\n            60\n          );\n          setFrameState({\n            fps: frameState.framesCount,\n            lastStamp: currentStamp,\n            framesCount: 0,\n            average: newMean,\n            totalCount,\n            lowestFps: Math.min(frameState.lowestFps, frameState.framesCount),\n          });\n        } else {\n          setFrameState({\n            ...frameState,\n            framesCount: newFramesCount,\n          });\n        }\n      }, 0);\n    });\n    return () => {\n      if (timeout) clearTimeout(timeout);\n    };\n  }, [frameState]);\n\n  const resetLowFpsFn = () => {\n    setFrameState({\n      ...frameState,\n      lowestFps: 240,\n    });\n  };\n\n  return {\n    average: frameState.average,\n    fps: frameState.fps,\n    lowestFps: frameState.lowestFps,\n    resetLowFps: resetLowFpsFn,\n    lastStamp: frameState.lastStamp,\n  };\n}\n"],"mappings":"AAAA,SAASA,SAAS,EAAEC,QAAQ,QAAQ,OAAO;AAY3C,OAAO,SAASC,YAAYA,CAAA,EAM1B;EACA,MAAM,CAACC,UAAU,EAAEC,aAAa,CAAC,GAAGH,QAAQ,CAAY;IACtDI,GAAG,EAAE,CAAC;IACNC,SAAS,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC;IACrBC,WAAW,EAAE,CAAC;IACdC,OAAO,EAAE,CAAC;IACVC,UAAU,EAAE,CAAC;IACbC,SAAS,EAAE;EACb,CAAC,CAAC;EAEFZ,SAAS,CAAC,MAAM;IACd;IACA;IACA;IACA,IAAIa,OAA8B,GAAG,IAAI;IAEzCC,qBAAqB,CAAC,MAAY;MAChCD,OAAO,GAAGE,UAAU,CAAC,MAAY;QAC/B,MAAMC,YAAY,GAAGT,IAAI,CAACC,GAAG,CAAC,CAAC;QAC/B,MAAMS,cAAc,GAAGD,YAAY,GAAGb,UAAU,CAACG,SAAS,GAAG,IAAI;QACjE,MAAMY,cAAc,GAAGf,UAAU,CAACM,WAAW,GAAG,CAAC;QACjD;QACA,IAAIQ,cAAc,EAAE;UAClB,MAAME,QAAQ,GAAGhB,UAAU,CAACM,WAAW;UACvC,MAAME,UAAU,GAAGR,UAAU,CAACQ,UAAU,GAAG,CAAC;UAC5C;UACA;UACA,MAAMS,OAAO,GAAGC,IAAI,CAACC,GAAG,CACtBnB,UAAU,CAACO,OAAO,GAAG,CAACS,QAAQ,GAAGhB,UAAU,CAACO,OAAO,IAAIC,UAAU,EACjE,EACF,CAAC;UACDP,aAAa,CAAC;YACZC,GAAG,EAAEF,UAAU,CAACM,WAAW;YAC3BH,SAAS,EAAEU,YAAY;YACvBP,WAAW,EAAE,CAAC;YACdC,OAAO,EAAEU,OAAO;YAChBT,UAAU;YACVC,SAAS,EAAES,IAAI,CAACC,GAAG,CAACnB,UAAU,CAACS,SAAS,EAAET,UAAU,CAACM,WAAW;UAClE,CAAC,CAAC;QACJ,CAAC,MAAM;UACLL,aAAa,CAAC;YACZ,GAAGD,UAAU;YACbM,WAAW,EAAES;UACf,CAAC,CAAC;QACJ;MACF,CAAC,EAAE,CAAC,CAAC;IACP,CAAC,CAAC;IACF,OAAO,MAAM;MACX,IAAIL,OAAO,EAAEU,YAAY,CAACV,OAAO,CAAC;IACpC,CAAC;EACH,CAAC,EAAE,CAACV,UAAU,CAAC,CAAC;EAEhB,MAAMqB,aAAa,GAAGA,CAAA,KAAM;IAC1BpB,aAAa,CAAC;MACZ,GAAGD,UAAU;MACbS,SAAS,EAAE;IACb,CAAC,CAAC;EACJ,CAAC;EAED,OAAO;IACLF,OAAO,EAAEP,UAAU,CAACO,OAAO;IAC3BL,GAAG,EAAEF,UAAU,CAACE,GAAG;IACnBO,SAAS,EAAET,UAAU,CAACS,SAAS;IAC/Ba,WAAW,EAAED,aAAa;IAC1BlB,SAAS,EAAEH,UAAU,CAACG;EACxB,CAAC;AACH","ignoreList":[]}